name: Deploy Documentation

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Docs version label for mike (e.g. 26.1.2b1)"
        required: true
        type: string
      checkout_ref:
        description: "Git ref to build docs from (tag/sha/branch). For releases, pass the tag name."
        required: true
        type: string
      aliases:
        description: "Space-separated aliases (e.g. 'latest stable')"
        required: false
        default: "latest stable"
        type: string

jobs:
  deploy-docs:
    name: Deploy versioned documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository (build from requested ref)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mike

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare documentation files
        run: |
          python3 scripts/update_docs.py
          python3 scripts/changelog.py
          cp README.md docs/index.md
          cp CONTRIBUTING.md docs/contribute.md
          cp CHANGELOG.md docs/release-notes.md

      - name: Deploy documentation with mike
        run: |
          VERSION="${{ inputs.version }}"
          DOCS_BRANCH="gh-pages"

          if [ -z "$VERSION" ] || echo "$VERSION" | grep -q '^refs/'; then
            echo "Error: Invalid version detected: '$VERSION'"
            exit 1
          fi

          # Convert aliases to args: "latest stable" => --aliases latest stable
          ALIASES="${{ inputs.aliases }}"

          python3 scripts/deploy_docs.py deploy \
            --version "$VERSION" \
            --aliases $ALIASES \
            --title "Release $VERSION" \
            --branch "$DOCS_BRANCH" \
            --ignore-remote-status \
            --push

          mike set-default stable --branch "$DOCS_BRANCH" --push

      - name: Checkout gh-pages branch content
        run: |
          git fetch origin gh-pages
          git checkout -B gh-pages origin/gh-pages

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
