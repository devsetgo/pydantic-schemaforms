
<!DOCTYPE html>
<html>
<head>
    <title>Model List Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Model List Test</h1>
        <form method="POST" action="/submit" class="needs-validation" novalidate="True" hx-post="/submit" hx-target="#form-response" hx-swap="innerHTML">

        <div class="mb-3">
            <label class="form-label fw-bold">
                Your Pets
                
            </label>
            
            <div class="model-list-container" 
                 data-field-name="pets"
                 data-min-items="0"
                 data-max-items="5">
                
                <div class="model-list-items" id="pets-items">
        <div class="model-list-item border rounded p-3 mb-2 bg-light" data-index="0">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0 text-primary">
                    <i class="bi bi-card-list"></i> 
                    Item #1
                </h6>
                <button type="button" 
                        class="btn btn-outline-danger btn-sm remove-item-btn"
                        data-index="0">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
<label class="form-label" for="pets[0].name">Pet Name</label>
<input name="pets[0].name" id="pets[0].name" class="form-control" placeholder="Enter pet name" type="text" />
</div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
<label class="form-label" for="pets[0].species">Species</label>
<input name="pets[0].species" id="pets[0].species" class="form-control" placeholder="dog, cat, fish, etc." type="text" />
</div>
                </div>
            </div>
        </div>
                </div>
                
                <div class="model-list-controls mt-2">
                    <button type="button" 
                            class="btn btn-outline-primary btn-sm add-item-btn"
                            data-target="pets">
                        <i class="bi bi-plus-circle"></i> Add Item
                    </button>
                </div>
            </div>
            <div class="form-text text-muted">
                <i class="bi bi-info-circle"></i> Add your pets
            </div></div>
<button type="submit" class="btn btn-primary">Submit</button>
</form>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeModelLists();
        });
        
        function initializeModelLists() {
            // Add item functionality
            document.querySelectorAll('.add-item-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const fieldName = this.dataset.target;
                    const container = document.querySelector(`[data-field-name="${fieldName}"]`);
                    const itemsContainer = container.querySelector('.model-list-items');
                    const maxItems = parseInt(container.dataset.maxItems);
                    const currentItems = itemsContainer.querySelectorAll('.model-list-item').length;
                    
                    if (currentItems >= maxItems) {
                        alert(`Maximum ${maxItems} items allowed.`);
                        return;
                    }
                    
                    // Clone the template or create new item
                    addNewListItem(fieldName, currentItems);
                    updateItemIndices(itemsContainer);
                });
            });
            
            // Remove item functionality
            document.addEventListener('click', function(e) {
                if (e.target.closest('.remove-item-btn')) {
                    const button = e.target.closest('.remove-item-btn');
                    const item = button.closest('.model-list-item');
                    const container = item.closest('.model-list-container');
                    const minItems = parseInt(container.dataset.minItems);
                    const itemsContainer = container.querySelector('.model-list-items');
                    const currentItems = itemsContainer.querySelectorAll('.model-list-item').length;
                    
                    if (currentItems <= minItems) {
                        alert(`Minimum ${minItems} items required.`);
                        return;
                    }
                    
                    item.remove();
                    updateItemIndices(itemsContainer);
                }
            });
        }
        
        function addNewListItem(fieldName, index) {
            // This would need to be customized based on the specific model structure
            // For now, we'll create a basic template
            const container = document.querySelector(`[data-field-name="${fieldName}"]`);
            const itemsContainer = container.querySelector('.model-list-items');
            
            // Get the first item as a template if it exists
            const firstItem = itemsContainer.querySelector('.model-list-item');
            if (firstItem) {
                const newItem = firstItem.cloneNode(true);
                
                // Clear all input values
                newItem.querySelectorAll('input, select, textarea').forEach(input => {
                    input.value = '';
                });
                
                // Update data-index
                newItem.dataset.index = index;
                
                // Update field names
                updateFieldNames(newItem, fieldName, index);
                
                itemsContainer.appendChild(newItem);
            }
        }
        
        function updateItemIndices(container) {
            const items = container.querySelectorAll('.model-list-item');
            items.forEach((item, index) => {
                item.dataset.index = index;
                
                // Update the title
                const title = item.querySelector('h6');
                if (title) {
                    title.textContent = title.textContent.replace(/#\d+/, `#${index + 1}`);
                }
                
                // Update field names
                const fieldName = container.closest('.model-list-container').dataset.fieldName;
                updateFieldNames(item, fieldName, index);
            });
        }
        
        function updateFieldNames(item, fieldName, index) {
            item.querySelectorAll('input, select, textarea').forEach(input => {
                if (input.name) {
                    // Update name attribute to use correct index
                    input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                }
                if (input.id) {
                    // Update id attribute
                    input.id = input.id.replace(/\[\d+\]/, `[${index}]`);
                }
            });
            
            item.querySelectorAll('label').forEach(label => {
                if (label.getAttribute('for')) {
                    label.setAttribute('for', label.getAttribute('for').replace(/\[\d+\]/, `[${index}]`));
                }
            });
        }
        </script>
        
<div id="form-response"></div>
<script src="https://unpkg.com/htmx.org@2.0.6"></script>
<script src="https://unpkg.com/imask"></script>
    </div>
</body>
</html>
        